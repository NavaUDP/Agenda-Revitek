from django.db.models.signals import pre_save, post_save
from django.dispatch import receiver
from .models import Reservation
from apps.whatsapp.services import MetaClient
import threading

@receiver(pre_save, sender=Reservation)
def track_status_change(sender, instance, **kwargs):
    """
    Rastrear si el estado cambia a CONFIRMED.
    """
    if instance.pk:
        try:
            old_instance = Reservation.objects.get(pk=instance.pk)
            instance._old_status = old_instance.status
        except Reservation.DoesNotExist:
            instance._old_status = None
    else:
        instance._old_status = None

@receiver(post_save, sender=Reservation)
def trigger_whatsapp_notifications(sender, instance, created, **kwargs):
    """
    Disparar notificaciones de WhatsApp basadas en cambios de estado.
    """
    import uuid
    from datetime import timedelta
    from django.utils import timezone
    
    old_status = getattr(instance, '_old_status', None)
    
    print(f"üîî Signal triggered - Old: {old_status}, New: {instance.status}, ID: {instance.id}")
    
    # Omitir si esta confirmaci√≥n vino del enlace (para prevenir bucle)
    if getattr(instance, '_confirmed_via_link', False):
        print(f"‚è≠Ô∏è  Confirmaci√≥n v√≠a link - no se env√≠a mensaje duplicado")
        return
    
    # Admin aprueba: Generar token y enviar enlace manteniendo estado PENDING
    # El token se genera solo una vez (cuando previamente no hab√≠a token)
    if instance.status == 'PENDING' and not instance.confirmation_token and old_status == 'PENDING':
        # Esto significa que el admin acaba de aprobar (primera vez viendo PENDING despu√©s de actualizaci√≥n)
        # Detectamos esto verificando si la reserva fue actualizada por el admin
        # Por simplicidad, enviaremos enlace cuando updated_at cambie significativamente
        pass  # Omitir por ahora - necesitamos un enfoque diferente
    
    # Mejor enfoque: Enviar enlace cuando se solicite expl√≠citamente v√≠a campo personalizado o acci√≥n
    # Por ahora, disparemos en cambio de estado a CONFIRMED
    if old_status == 'PENDING' and instance.status == 'CONFIRMED':
        print(f"‚úÖ Admin aprob√≥ - generando token y esperando confirmaci√≥n del cliente...")
        
        # Cambiar estado a WAITING_CLIENT
        instance.status = 'WAITING_CLIENT'
        
        def send_confirmation_link():
            try:
                # Generar token √∫nico
                token = uuid.uuid4()
                expiration = timezone.now() + timedelta(hours=2)
                
                print(f"üîë Token generado: {token}")
                
                # Guardar token en reserva y actualizar estado
                instance.confirmation_token = token
                instance.token_expires_at = expiration
                instance.save(update_fields=['confirmation_token', 'token_expires_at', 'status'])
                
                print(f"üíæ Token guardado - estado: {instance.status}")
                
                # Enviar WhatsApp con enlace
                client = MetaClient()
                result = client.send_confirmation_link(instance, token)
                print(f"üì± WhatsApp enviado: {result}")
            except Exception as e:
                print(f"‚ùå Error sending WhatsApp confirmation link: {e}")
                import traceback
                traceback.print_exc()
        
        threading.Thread(target=send_confirmation_link).start()
    else:
        print(f"‚è≠Ô∏è  No se env√≠a link (condici√≥n no cumplida)")


